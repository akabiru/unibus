RESET=${RESET:-0}
CIRCLE_TEST_REPORTS=${CIRCLE_TEST_REPORTS:-.}

for subdir in $(find . -type d -name spec -exec dirname '{}' \;); do
    cd $subdir
    echo $subdir
    bundle 2>&1 > /dev/null
    (( RESET )) && RAILS_ENV=test rake db:reset
    bundle exec rake SPEC_OPTS="-r rspec_junit_formatter --format progress --format RspecJunitFormatter -o $CIRCLE_TEST_REPORTS/rspec/junit.xml"
    cd -
done
